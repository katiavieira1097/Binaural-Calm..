<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binaural Calm</title>
    <link rel="manifest"
       href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-blue-100">
    <div id="root"></div>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.1.8/recharts.min.js"></script>
    <script type="text/babel">
        // Funções utilitárias
        const downloadFile = async (url, filename) => {
          try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`Erro HTTP! Status: ${res.status}`);
            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = blobUrl; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(blobUrl);
            return { success: true };
          } catch (e) { return { success: false, message: `Erro ao baixar ${filename}: ${e.message}` }; }
        };
        const bufferToWave = (abuffer, len, sampleRate) => {
          const nC = 1, l = len * nC * 2 + 44, b = new ArrayBuffer(l), v = new DataView(b); let o = 0;
          const ws = (v, o, s) => { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)); };
          const f16BPCM = (o, off, i) => { for (let j = 0; j < i.length; j++, off += 2) { const s = Math.max(-1, Math.min(1, i[j])); o.setInt16(off, s < 0 ? s * 0x8000 : s * 0x7FFF, true); } };
          ws(v, o, 'RIFF'); o += 4; v.setUint32(o, 36 + len * nC * 2, true); o += 4; ws(v, o, 'WAVE'); o += 4;
          ws(v, o, 'fmt '); o += 4; v.setUint32(o, 16, true); o += 4; v.setUint16(o, 1, true); o += 2;
          v.setUint16(o, nC, true); o += 2; v.setUint32(o, sampleRate, true); o += 4;
          v.setUint32(o, sampleRate * nC * 2, true); o += 4; v.setUint16(o, nC * 2, true); o += 2;
          v.setUint16(o, 16, true); o += 2; ws(v, o, 'data'); o += 4; v.setUint32(o, len * nC * 2, true); o += 4;
          f16BPCM(v, o, abuffer); return new Blob([v], { type: 'audio/wav' });
        };
        const formatDate = (iso) => new Date(iso).toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

        // Contexto e Provedor do Aplicativo (sem Firebase)
        const AppContext = React.createContext(null);
        const AppProvider = ({ children }) => {
          const [loading, setLoading] = React.useState(false); // Não há carregamento de Firebase
          const [error, setError] = React.useState(null); // Não há erros de Firebase

          // Função para iniciar o contexto de áudio do Tone.js
          const startAudioContext = async () => {
            if (Tone.context.state !== 'running') { try { await Tone.start(); } catch (e) { console.error("Erro ao retomar o contexto de áudio:", e); } }
          };
          React.useEffect(() => { startAudioContext(); }, []);

          if (loading) return (<div className="flex items-center justify-center min-h-screen bg-blue-100 text-blue-800">Carregando aplicativo...</div>);
          if (error) return (<div className="flex items-center justify-center min-h-screen bg-red-100 text-red-800">Erro: {error}</div>);
          return (<AppContext.Provider value={{ startAudioContext }}>{children}</AppContext.Provider>);
        };
        const useAppContext = () => React.useContext(AppContext);

        // Cabeçalho e Rodapé
        const HeaderTitle = () => (<header className="w-full text-center py-2 bg-blue-700 rounded-b-lg shadow-md flex items-center justify-center px-4"><div className="flex-grow text-center"><h1 className="text-lg font-bold text-blue-200">Binaural Calm</h1></div></header>);
        const FooterNav = () => (<footer className="fixed bottom-0 left-0 w-full bg-blue-700 text-white p-2 shadow-lg z-50 flex justify-center items-center"><p className="text-xs text-blue-200 text-center">Binaural Calm: Sons para foco e tranquilidade.</p></footer>);

        // Componente Home
        const Home = ({ setView }) => {
          const navItems = [
            { id: 'binaural', icon: (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6 mx-auto mb-1"><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9.006 17.5c-2.795 1.543-3.45 4.002-1.779 5.689 1.671 1.688 4.129 1.032 5.672-1.766l.708-1.284m-.531-9.07l1.284-.707c2.795-1.543 3.45-4.002 1.779-5.689-1.671-1.688-4.129-1.032-5.672 1.766L7.99 4.5M14.009 10.406L9.009 15.406m5.004-5L19 10.406m-5 0l-5 5" /></svg>), label: 'Gerador' },
            { id: 'routine', icon: (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6 mx-auto mb-1"><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12v-.008zM12 18h.008v.008H12v-.008z" /></svg>), label: 'Rotina' },
            { id: 'selfAssessment', icon: (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6 mx-auto mb-1"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>), label: 'Avaliação' },
            { id: 'soundLibrary', icon: (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6 mx-auto mb-1"><path strokeLinecap="round" strokeLinejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25H21M7.5 12H3m0 0l3-3m-3 3l3 3m0 0h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25H21" /></svg>), label: 'Músicas' },
            { id: 'userPlaylist', icon: (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6 mx-auto mb-1"><path strokeLinecap="round" strokeLinejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.835 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>), label: 'Playlist' },
            { id: 'communication', icon: (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6 mx-auto mb-1"><path strokeLinecap="round" strokeLinejoin="round" d="M20.25 8.515C20.25 14.636 15.136 19.75 9 19.75c-1.89 0-3.68-.48-5.25-1.325L3 21l2.25-2.25c1.194.39 2.476.605 3.75.605 6.136 0 11.25-5.114 11.25-11.25S15.136 3 9 3 3 8.114 3 14.25z" /></svg>), label: 'Comunicação' },
            { id: 'aiHelper', icon: (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6 mx-auto mb-1"><path strokeLinecap="round" strokeLinejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 6a6 6 0 01-6-6v-1.5m6 6v3.75m-3.75 0h7.5M12 10.5V3.75m-3.75 0h7.5M12 10.5h.008v.008H12v-.008zM12 18.75h.008v.008H12v-.008z" /></svg>), label: 'IA' },
            { id: 'creativeMusicRequest', icon: (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6 mx-auto mb-1"><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>), label: 'Música Criativa' },
          ];
          return (<div className="p-3 sm:p-4 text-center bg-gradient-to-br from-blue-900 to-blue-700 rounded-lg shadow-lg flex flex-col items-center justify-center min-h-[calc(100vh-120px)] text-white"><h2 className="text-2xl sm:text-3xl font-bold text-blue-200 mb-4">Bem-vindo ao Binaural Calm</h2><p className="text-sm sm:text-base text-blue-100 mb-6">Seu guia para tranquilidade e bem-estar.</p><div className="grid grid-cols-3 gap-4 sm:gap-6 max-w-md mx-auto">{navItems.map(item => (<button key={item.id} onClick={() => setView(item.id)} className="flex flex-col items-center justify-center bg-white bg-opacity-20 hover:bg-opacity-30 p-3 rounded-full shadow-lg transition duration-300 text-blue-100">{item.icon}<span className="mt-1 text-xs font-semibold">{item.label}</span></button>))}</div></div>);
        };

        // Componente Gerador de Sons Binaurais
        const BinauralGenerator = ({ setView }) => {
          const { startAudioContext } = useAppContext();
          const [behavior, setBehavior] = React.useState(''); const [trigger, setTrigger] = React.useState('');
          const [frequencyDiff, setFrequencyDiff] = React.useState(5); const [baseFrequency, setBaseFrequency] = React.useState(220);
          const [isPlaying, setIsPlaying] = React.useState(false); const [player, setPlayer] = React.useState(null);
          const [message, setMessage] = React.useState('');

          React.useEffect(() => {
            return () => { // Limpeza do Tone.js ao desmontar o componente
              if (player) { player.osc1.stop(); player.osc2.stop(); player.osc1.dispose(); player.osc2.dispose(); player.masterGain.dispose(); player.filter.dispose(); player.reverb.dispose(); setPlayer(null); }
              Tone.Transport.stop(); Tone.Transport.cancel();
            };
          }, [player]);

          const createBinauralPlayer = (diff, base) => {
            const masterGain = new Tone.Gain(0.5).toDestination();
            const filter = new Tone.Filter(4000, "lowpass").connect(masterGain);
            const reverb = new Tone.Reverb({ decay: 2, wet: 0.2 }).connect(filter); reverb.generate();
            const osc1 = new Tone.Oscillator({ frequency: base, type: "sine", envelope: { attack: 1.0, decay: 0.1, sustain: 1, release: 2.0 } }).connect(reverb);
            const osc2 = new Tone.Oscillator({ frequency: base + diff, type: "sine", envelope: { attack: 1.0, decay: 0.1, sustain: 1, release: 2.0 } }).connect(reverb);
            setPlayer({ osc1, osc2, masterGain, filter, reverb }); return { osc1, osc2, masterGain, filter, reverb };
          };

          const playSound = async () => {
            await startAudioContext();
            if (player) { player.osc1.stop(); player.osc2.stop(); player.osc1.dispose(); player.osc2.dispose(); player.masterGain.dispose(); player.filter.dispose(); player.reverb.dispose(); }
            const newPlayer = createBinauralPlayer(frequencyDiff, baseFrequency);
            newPlayer.osc1.start(); newPlayer.osc2.start(); setIsPlaying(true); setMessage('Som binaural a tocar...');
          };
          const stopSound = () => {
            if (player) { player.osc1.stop(); player.osc2.stop(); player.osc1.dispose(); player.osc2.dispose(); player.masterGain.dispose(); player.filter.dispose(); player.reverb.dispose(); setPlayer(null); }
            setIsPlaying(false); setMessage('Som parado.');
          };

          const handleDownloadBinaural = async () => {
            await startAudioContext(); const offlineCtx = new Tone.OfflineContext(10, 44100); Tone.setContext(offlineCtx);
            const mg = new Tone.Gain(0.5).toDestination(); const f = new Tone.Filter(4000, "lowpass").connect(mg);
            const r = new Tone.Reverb({ decay: 2, wet: 0.2 }).connect(f); r.generate();
            const o1 = new Tone.Oscillator({ frequency: baseFrequency, type: "sine", envelope: { attack: 1.0, decay: 0.1, sustain: 1, release: 2.0 } }).connect(r);
            const o2 = new Tone.Oscillator({ frequency: baseFrequency + frequencyDiff, type: "sine", envelope: { attack: 1.0, decay: 0.1, sustain: 1, release: 2.0 } }).connect(r);
            o1.start(0); o2.start(0); o1.stop(offlineCtx.duration); o2.stop(offlineCtx.duration);
            try {
              const buffer = await offlineCtx.render(); const audioBlob = bufferToWave(buffer.getChannelData(0), buffer.length, buffer.sampleRate);
              const res = await downloadFile(URL.createObjectURL(audioBlob), `som_binaural_${baseFrequency}Hz_diff${frequencyDiff}Hz.wav`);
              if (res.success) setMessage("Download do som binaural iniciado!"); else alert(res.message);
            } catch (e) { console.error("Erro ao renderizar ou baixar som binaural:", e); setMessage("Erro ao baixar o som binaural."); }
            finally { Tone.setContext(Tone.context); mg.dispose(); f.dispose(); r.dispose(); o1.dispose(); o2.dispose(); }
          };

          // Funcionalidades de salvar/editar/excluir sons binaurais foram removidas (dependiam do Firebase)
          return (<div className="p-3 sm:p-4 bg-white rounded-lg shadow-lg"><button onClick={() => setView('home')} className="mb-3 px-3 py-1.5 text-sm bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Voltar</button><h2 className="text-lg sm:text-xl font-bold text-blue-700 mb-2">Gerador de Sons Binaurais</h2><p className="text-xs sm:text-sm text-gray-700 mb-3">Crie sons personalizados para acalmar durante uma crise, baseados em seu comportamento e gatilhos. Experimente ajustar a Frequência Base e a Diferença de Frequência para encontrar o som que melhor se adapta à sua necessidade (por exemplo, frequências mais baixas e diferenças menores para relaxamento, ou frequências ligeiramente mais altas para foco).</p><div className="mb-2"><label htmlFor="behavior" className="block text-gray-700 text-xs font-bold mb-1">Comportamento:</label><input type="text" id="behavior" value={behavior} onChange={(e) => e.target.value.length <= 50 ? setBehavior(e.target.value) : null} placeholder="Ex: Agitação, choro" className="shadow border rounded w-full py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs" maxLength="50" /></div><div className="mb-2"><label htmlFor="trigger" className="block text-gray-700 text-xs font-bold mb-1">Gatilhos:</label><input type="text" id="trigger" value={trigger} onChange={(e) => e.target.value.length <= 50 ? setTrigger(e.target.value) : null} placeholder="Ex: Ruídos altos" className="shadow border rounded w-full py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs" maxLength="50" /></div><div className="mb-2"><label htmlFor="baseFrequency" className="block text-gray-700 text-xs font-bold mb-1">Freq. Base (Hz): {baseFrequency.toFixed(0)}</label><input type="range" id="baseFrequency" min="100" max="500" value={baseFrequency} onChange={(e) => setBaseFrequency(parseFloat(e.target.value))} className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" /></div><div className="mb-3"><label htmlFor="frequencyDiff" className="block text-gray-700 text-xs font-bold mb-1">Dif. Freq (Hz): {frequencyDiff.toFixed(1)}</label><input type="range" id="frequencyDiff" min="1" max="10" step="0.1" value={frequencyDiff} onChange={(e) => setFrequencyDiff(parseFloat(e.target.value))} className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" /></div><div className="flex flex-wrap gap-1 sm:gap-2 mb-3"><button onClick={() => isPlaying ? stopSound() : playSound()} className={`px-2 py-1 text-xs sm:px-3 sm:py-1.5 bg-green-600 text-white font-bold rounded-lg shadow-md ${isPlaying ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-700'} transition duration-300 flex-grow`}>{isPlaying ? 'Parar e Gerar Novo' : 'Gerar e Tocar'}</button><button onClick={stopSound} disabled={!isPlaying} className={`px-2 py-1 text-xs sm:px-3 sm:py-1.5 bg-red-600 text-white font-bold rounded-lg shadow-md ${!isPlaying ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-700'} transition duration-300 flex-grow`}>Parar</button><button onClick={handleDownloadBinaural} className="px-2 py-1 text-xs sm:px-3 sm:py-1.5 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 flex-grow">Download WAV</button></div>{message && <p className="text-center text-xs text-gray-600 mb-2">{message}</p>}</div>);
        };

        // Componente Rotina Diária (dados não persistentes)
        const DailyRoutine = ({ setView }) => {
          const [morningTasks, setMorningTasks] = React.useState([]); const [afternoonTasks, setAfternoonTasks] = React.useState([]);
          const [eveningTasks, setEveningTasks] = React.useState([]); const [newTask, setNewTask] = React.useState('');
          const [newTimeOfDay, setNewTimeOfDay] = React.useState('morning'); const [newAlarmTime, setNewAlarmTime] = React.useState('');
          const [message, setMessage] = React.useState(''); const [showAlarmModal, setShowAlarmModal] = React.useState(false);
          const [currentAlarmTask, setCurrentAlarmTask] = React.useState(''); const alarmIntervalRef = React.useRef(null);

          React.useEffect(() => {
            if (alarmIntervalRef.current) clearInterval(alarmIntervalRef.current);
            alarmIntervalRef.current = setInterval(() => {
              const now = new Date(); const cH = now.getHours(); const cM = now.getMinutes();
              const checkAndTriggerAlarm = (tasks) => {
                tasks.forEach(t => {
                  if (t.alarmTime) {
                    const [aH, aM] = t.alarmTime.split(':').map(Number);
                    if (cH === aH && cM === aM) {
                      const lastTriggered = localStorage.getItem(`alarm-${t.id}`);
                      if (!lastTriggered || (now.getTime() - parseInt(lastTriggered, 10) > 59000)) {
                        setCurrentAlarmTask(t.task); setShowAlarmModal(true); localStorage.setItem(`alarm-${t.id}`, now.getTime().toString());
                        new Tone.Synth().toDestination().triggerAttackRelease("C5", "8n");
                      }
                    }
                  }
                });
              };
              checkAndTriggerAlarm(morningTasks); checkAndTriggerAlarm(afternoonTasks); checkAndTriggerAlarm(eveningTasks);
            }, 5000);
            return () => { if (alarmIntervalRef.current) clearInterval(alarmIntervalRef.current); };
          }, [morningTasks, afternoonTasks, eveningTasks]);

          const handleAddTask = () => {
            if (!newTask.trim()) { setMessage("A tarefa não pode estar vazia."); return; }
            const newTaskObj = { id: Date.now().toString(), task: newTask, timeOfDay: newTimeOfDay, alarmTime: newAlarmTime || null, timestamp: new Date().toISOString() };
            if (newTimeOfDay === 'morning') setMorningTasks(prev => [...prev, newTaskObj]);
            else if (newTimeOfDay === 'afternoon') setAfternoonTasks(prev => [...prev, newTaskObj]);
            else setEveningTasks(prev => [...prev, newTaskObj]);
            setNewTask(''); setNewAlarmTime(''); setMessage("Tarefa adicionada temporariamente!");
          };
          const handleDeleteTask = (tId) => {
            setMorningTasks(prev => prev.filter(t => t.id !== tId));
            setAfternoonTasks(prev => prev.filter(t => t.id !== tId));
            setEveningTasks(prev => prev.filter(t => t.id !== tId));
            setMessage("Tarefa excluída temporariamente!");
          };

          const renderTaskList = (tasks, title) => (<div className="bg-blue-50 p-2 sm:p-3 rounded-lg shadow-sm"><h3 className="text-base sm:text-lg font-semibold text-blue-700 mb-1">{title}</h3>{tasks.length === 0 ? (<p className="text-xs text-gray-600">Nenhuma tarefa para {title.toLowerCase()}.</p>) : (<ul className="space-y-1">{tasks.map(t => (<li key={t.id} className="flex justify-between items-center bg-white p-1.5 rounded-md shadow-xs"><span className="text-xs text-gray-800">{t.task} {t.alarmTime && <span className="text-blue-500 text-xs">({t.alarmTime})</span>}</span><button onClick={() => handleDeleteTask(t.id)} className="px-1.5 py-0.5 text-xs bg-red-600 text-white rounded-md hover:bg-red-700">Excluir</button></li>))}</ul>)}</div>);

          return (<div className="p-3 sm:p-4 bg-white rounded-lg shadow-lg"><button onClick={() => setView('home')} className="mb-3 px-3 py-1.5 text-sm bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Voltar</button><h2 className="text-lg sm:text-xl font-bold text-blue-700 mb-2">Rotina Diária</h2><p className="text-xs sm:text-sm text-gray-700 mb-3">Organize suas tarefas para manhã, tarde e noite para uma estrutura previsível. (Dados não persistentes)</p><div className="mb-3 p-2 border border-blue-200 rounded-lg"><h3 className="text-base sm:text-lg font-semibold text-blue-700 mb-1">Adicionar Nova Tarefa</h3><div className="flex flex-col sm:flex-row gap-1 sm:gap-2 mb-2"><input type="text" value={newTask} onChange={(e) => setNewTask(e.target.value)} placeholder="Descreva a tarefa" className="shadow border rounded w-full sm:w-1/2 py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs" /><input type="time" value={newAlarmTime} onChange={(e) => setNewAlarmTime(e.target.value)} className="shadow border rounded w-full sm:w-1/4 py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs" title="Definir hora do alarme" /><select value={newTimeOfDay} onChange={(e) => setNewTimeOfDay(e.target.value)} className="shadow border rounded w-full sm:w-1/4 py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs"><option value="morning">Manhã</option><option value="afternoon">Tarde</option><option value="evening">Noite</option></select></div><button onClick={handleAddTask} className="px-3 py-1.5 text-sm bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 w-full">Adicionar Tarefa</button>{message && <p className="text-center text-xs text-gray-600 mt-1">{message}</p>}</div><div className="grid grid-cols-1 md:grid-cols-3 gap-2 sm:gap-3">{renderTaskList(morningTasks, 'Manhã')}{renderTaskList(afternoonTasks, 'Tarde')}{renderTaskList(eveningTasks, 'Noite')}</div>{showAlarmModal && (<div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-2"><div className="bg-white p-4 sm:p-5 rounded-lg shadow-xl text-center w-full max-w-xs mx-auto"><h3 className="text-lg sm:text-xl font-bold text-blue-700 mb-2">ALARM!</h3><p className="text-sm text-gray-800 mb-3">Hora de: <span className="font-semibold">{currentAlarmTask}</span></p><button onClick={() => setShowAlarmModal(false)} className="px-3 py-1.5 text-sm bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">Entendi</button></div></div>)}</div>);
        };

        // Gráfico de Progresso Mensal (dados não persistentes)
        const MonthlyProgressChart = () => {
          const [crisisData, setCrisisData] = React.useState([]); const [message, setMessage] = React.useState('Nenhum dado de crise persistente. Este gráfico mostra apenas dados de sessão.');
          React.useEffect(() => { setCrisisData([]); }, []);
          return (<div className="p-3 sm:p-4 bg-white rounded-lg shadow-lg mt-3"><h2 className="text-lg sm:text-xl font-bold text-blue-700 mb-2">Evolução Mensal das Crises</h2><p className="text-xs sm:text-sm text-gray-700 mb-3">Acompanhe a média do nível de suas crises ao longo dos meses. (Dados não persistentes)</p>{message && <p className="text-center text-xs text-gray-600 mb-3">{message}</p>}{crisisData.length > 0 && (<Recharts.ResponsiveContainer width="100%" height={200}><Recharts.LineChart data={crisisData} margin={{ top: 5, right: 5, left: 0, bottom: 5 }}><Recharts.CartesianGrid strokeDasharray="3 3" /><Recharts.XAxis dataKey="name" tick={{fontSize: 8}} /><Recharts.YAxis domain={[0, 5]} tick={{fontSize: 8}} /><Recharts.Tooltip /><Recharts.Legend wrapperStyle={{fontSize: '10px'}} /><Recharts.Line type="monotone" dataKey="Nível Médio de Crise" stroke="#8884d8" activeDot={{ r: 6 }} /></Recharts.LineChart></Recharts.ResponsiveContainer>)}</div>);
        };

        // Autoavaliação (dados não persistentes)
        const SelfAssessment = ({ setView }) => {
          const [assessmentText, setAssessmentText] = React.useState(''); const [crisisLevel, setCrisisLevel] = React.useState(3);
          const [assessments, setAssessments] = React.useState([]); const [message, setMessage] = React.useState('');
          React.useEffect(() => { setAssessments([]); }, []);
          const handleSaveAssessment = () => {
            if (!assessmentText.trim()) { setMessage("A autoavaliação não pode estar vazia."); return; }
            const newAssessment = { id: Date.now().toString(), text: assessmentText, crisisLevel: crisisLevel, timestamp: new Date().toISOString() };
            setAssessments(prev => { const updated = [...prev, newAssessment]; updated.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); return updated; });
            setAssessmentText(''); setCrisisLevel(3); setMessage("Autoavaliação guardada temporariamente!");
          };
          const handleDeleteAssessment = (aId) => { setAssessments(prev => prev.filter(a => a.id !== aId)); setMessage("Autoavaliação excluída temporariamente!"); };

          return (<div className="p-3 sm:p-4 bg-white rounded-lg shadow-lg"><button onClick={() => setView('home')} className="mb-3 px-3 py-1.5 text-sm bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Voltar</button><h2 className="text-lg sm:text-xl font-bold text-blue-700 mb-2">Autoavaliação</h2><p className="text-xs sm:text-sm text-gray-700 mb-3">Acompanhe seu desenvolvimento e bem-estar após ouvir os sons. (Dados não persistentes)</p><div className="mb-3 p-2 border border-blue-200 rounded-lg"><h3 className="text-base sm:text-lg font-semibold text-blue-700 mb-1">Registar Avaliação</h3><textarea value={assessmentText} onChange={(e) => setAssessmentText(e.target.value)} placeholder="Como você se sente hoje? O que você notou após ouvir os sons?" rows="3" className="shadow border rounded w-full py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs mb-2"></textarea><div className="mb-2"><label htmlFor="crisisLevel" className="block text-gray-700 text-xs font-bold mb-1">Nível da Crise (0=Nenhuma, 5=Muito Alta): {crisisLevel}</label><input type="range" id="crisisLevel" min="0" max="5" step="1" value={crisisLevel} onChange={(e) => setCrisisLevel(parseInt(e.target.value))} className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" /></div><button onClick={handleSaveAssessment} className="px-3 py-1.5 text-sm bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 w-full">Guardar Avaliação (Temporário)</button>{message && <p className="text-center text-xs text-gray-600 mt-1">{message}</p>}</div><h3 className="text-base sm:text-lg font-bold text-blue-700 mb-1">Minhas Avaliações (Temporário)</h3>{assessments.length === 0 ? (<p className="text-xs text-gray-600">Nenhuma autoavaliação registada ainda nesta sessão.</p>) : (<ul className="space-y-1.5">{assessments.map(a => (<li key={a.id} className="bg-blue-50 p-2 rounded-lg shadow-sm"><p className="text-xs sm:text-sm text-gray-800 mb-1">{a.text}</p><p className="text-xs text-gray-600">Nível da Crise: {a.crisisLevel !== undefined ? a.crisisLevel : 'N/A'}</p><div className="flex justify-between items-center text-xs text-gray-500 mt-1"><span>{formatDate(a.timestamp)}</span><button onClick={() => handleDeleteAssessment(a.id)} className="px-1.5 py-0.5 text-xs bg-red-600 text-white rounded-md hover:bg-red-700">Excluir</button></div></li>))}</ul>)}<MonthlyProgressChart /></div>);
        };

        // Biblioteca de Músicas (SoundHelix)
        const SoundLibrary = ({ setView }) => {
          const sounds = [
            { id: 'sh_1', name: 'SoundHelix Song 1', description: 'Melodia cativante e leve.', image: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
            { id: 'sh_2', name: 'SoundHelix Song 2', description: 'Vibrações retro e alegres.', image: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
            { id: 'sh_3', name: 'SoundHelix Song 3', description: 'Sons cintilantes e energéticos.', image: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
            { id: 'sh_4', name: 'SoundHelix Song 4', description: 'Batidas urbanas com synth.', image: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' },
            { id: 'sh_5', name: 'SoundHelix Song 5', description: 'Leve e perfeito para o verão.', image: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' },
            { id: 'sh_6', name: 'SoundHelix Song 6', description: 'Batida pulsante e hipnótica.', image: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3' },
            { id: 'sh_7', name: 'SoundHelix Song 7', description: 'Atmosfera intensa e envolvente.', image: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3' },
            { id: 'sh_8', name: 'SoundHelix Song 8', description: 'Viagem sonora pelo espaço.', image: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3' },
            { id: 'sh_9', name: 'SoundHelix Song 9', description: 'Ritmo constante e energético.', image: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3' },
            { id: 'sh_10', name: 'SoundHelix Song 10', description: 'Pads e sintetizadores profundos.', image: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3' },
          ];
          return (<div className="p-3 sm:p-4 bg-white rounded-lg shadow-lg"><button onClick={() => setView('home')} className="mb-3 px-3 py-1.5 text-sm bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Voltar</button><h2 className="text-lg sm:text-xl font-bold text-blue-700 mb-2">Biblioteca de Músicas</h2><p className="text-xs sm:text-sm text-gray-700 mb-3 font-bold text-blue-700">Ao clicar no botão "Ouvir / Download", o link da música será aberto numa **nova aba do seu navegador**, onde poderá ouvir o som e descarregar o ficheiro MP3.</p><div className="grid grid-cols-2 gap-2 sm:gap-3">{sounds.map(s => (<div key={s.id} className="bg-blue-50 p-2 rounded-lg shadow-md flex flex-col items-center text-center"><img src={s.image} alt={s.name} className="w-16 h-16 sm:w-20 sm:h-20 rounded-full mb-2 object-cover" onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/80x80/CCCCCC/000?text=Capa`; }} /><h3 className="text-sm sm:text-base font-semibold text-blue-800 mb-1">{s.name}</h3><p className="text-xs text-gray-700 mb-2">{s.description}</p><div className="flex flex-col gap-1 w-full"><button onClick={() => window.open(s.audioUrl, '_blank')} className="px-2 py-1 text-xs rounded-lg font-bold shadow-md transition duration-300 bg-purple-600 hover:bg-purple-700 text-white inline-flex items-center justify-center">Ouvir / Download</button></div></div>))}</div></div>);
        };

        // Componente Playlist do Usuário (dados não persistentes, com equalizador)
        const UserPlaylist = ({ setView }) => {
          const { startAudioContext } = useAppContext();
          const [playlistSongs, setPlaylistSongs] = React.useState([]);
          const [newSongName, setNewSongName] = React.useState(''); const [newCoverImage, setNewCoverImage] = React.useState('');
          const [newAudioUrl, setNewAudioUrl] = React.useState(''); const [message, setMessage] = React.useState('');
          const [currentPlayingSong, setCurrentPlayingSong] = React.useState(null);
          const playerRef = React.useRef(null); const eqRef = React.useRef(null);
          const [lowGain, setLowGain] = React.useState(0); const [midGain, setMidGain] = React.useState(0); const [highGain, setHighGain] = React.useState(0);

          React.useEffect(() => { return () => { stopPlayingSong(); }; }, []);
          React.useEffect(() => { if (eqRef.current) { eqRef.current.low.value = lowGain; eqRef.current.mid.value = midGain; eqRef.current.high.value = highGain; } }, [lowGain, midGain, highGain]);

          const handleAddSong = () => {
            if (!newSongName.trim()) { setMessage("O nome da música não pode estar vazio."); return; }
            const newSong = { id: Date.now().toString(), name: newSongName, coverImage: newCoverImage || 'https://placehold.co/100x100/CCCCCC/000?text=Sem+Capa', audioUrl: newAudioUrl || '', timestamp: new Date().toISOString() };
            setPlaylistSongs(prev => [...prev, newSong]);
            setNewSongName(''); setNewCoverImage(''); setNewAudioUrl(''); setMessage("Música adicionada (temporariamente)!");
          };
          const handleDeleteSong = (sId) => { if (currentPlayingSong && currentPlayingSong.id === sId) stopPlayingSong(); setPlaylistSongs(prev => prev.filter(s => s.id !== sId)); setMessage("Música excluída (temporariamente)!"); };

          const playSong = async (s) => {
            await startAudioContext(); stopPlayingSong();
            if (!s.audioUrl || s.audioUrl.trim() === '') { setMessage("Esta música não tem uma URL de áudio válida."); return; }
            try {
              playerRef.current = new Tone.Player(s.audioUrl).toDestination();
              playerRef.current.autostart = true; playerRef.current.loop = true; playerRef.current.volume.value = -10;
              eqRef.current = new Tone.EQ3(lowGain, midGain, highGain).toDestination();
              playerRef.current.connect(eqRef.current); playerRef.current.toDestination();
              setCurrentPlayingSong(s); setMessage(`A tocar: ${s.name}`);
            } catch (e) { console.error("Erro ao tocar música:", e); setMessage(`Erro ao tocar ${s.name}.`); }
          };
          const stopPlayingSong = () => {
            if (playerRef.current) { playerRef.current.stop(); playerRef.current.dispose(); playerRef.current = null; }
            if (eqRef.current) { eqRef.current.dispose(); eqRef.current = null; }
            setCurrentPlayingSong(null); setMessage('Música parada.');
          };

          return (<div className="p-3 sm:p-4 bg-white rounded-lg shadow-lg"><button onClick={() => setView('home')} className="mb-3 px-3 py-1.5 text-sm bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Voltar</button><h2 className="text-lg sm:text-xl font-bold text-blue-700 mb-2">Minha Playlist Favorita</h2><p className="text-xs sm:text-sm text-gray-700 mb-3">Adicione quantas músicas quiser e equalize o som! (Dados não persistentes)</p><div className={`mb-3 p-2 border border-blue-200 rounded-lg`}><h3 className="text-base sm:text-lg font-semibold text-blue-700 mb-1">Adicionar Música</h3><div className="flex flex-col sm:flex-row gap-1 mb-2"><input type="text" value={newSongName} onChange={(e) => setNewSongName(e.target.value)} placeholder="Nome" className="shadow border rounded w-full sm:w-1/3 py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs" /><input type="text" value={newCoverImage} onChange={(e) => setNewCoverImage(e.target.value)} placeholder="URL Capa (opcional)" className="shadow border rounded w-full sm:w-1/3 py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs" /><input type="text" value={newAudioUrl} onChange={(e) => setNewAudioUrl(e.target.value)} placeholder="URL Áudio (MP3)" className="shadow border rounded w-full sm:w-1/3 py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs" /></div><button onClick={handleAddSong} className={`px-3 py-1.5 text-sm bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 w-full`}>Adicionar (Temporário)</button>{message && <p className="text-center text-xs text-gray-600 mt-1">{message}</p>}</div>{currentPlayingSong && (<div className="mb-4 p-3 border border-blue-300 rounded-lg bg-blue-50"><h3 className="text-base sm:text-lg font-semibold text-blue-700 mb-2">Equalizador</h3><div className="flex flex-col sm:flex-row justify-around items-center gap-3"><div className="flex flex-col items-center w-full sm:w-1/3"><label className="text-xs text-gray-700 mb-1">Graves ({lowGain} dB)</label><input type="range" min="-12" max="12" step="1" value={lowGain} onChange={(e) => setLowGain(parseFloat(e.target.value))} className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" /></div><div className="flex flex-col items-center w-full sm:w-1/3"><label className="text-xs text-gray-700 mb-1">Médios ({midGain} dB)</label><input type="range" min="-12" max="12" step="1" value={midGain} onChange={(e) => setMidGain(parseFloat(e.target.value))} className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" /></div><div className="flex flex-col items-center w-full sm:w-1/3"><label className="text-xs text-gray-700 mb-1">Agudos ({highGain} dB)</label><input type="range" min="-12" max="12" step="1" value={highGain} onChange={(e) => setHighGain(parseFloat(e.target.value))} className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" /></div></div></div>)}<h3 className="text-base sm:text-lg font-bold text-blue-700 mb-1">Minhas Músicas (Temporário)</h3>{playlistSongs.length === 0 ? (<p className="text-xs text-gray-600">Nenhuma música na playlist ainda nesta sessão.</p>) : (<ul className="space-y-1.5">{playlistSongs.map(s => (<li key={s.id} className="bg-blue-50 p-2 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center"><div className="flex items-center gap-2"><img src={s.coverImage} alt={s.name ? `Capa de ${s.name}` : 'Capa da música'} className="w-10 h-10 sm:w-12 sm:h-12 rounded-md object-cover" onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/48x48/CCCCCC/000?text=Capa`; }} /><div><p className="font-semibold text-blue-800 text-xs sm:text-sm">{s.name}</p><p className="text-xs text-gray-500">Adicionado: {formatDate(s.timestamp)}</p></div></div><div className="flex gap-1 mt-1 sm:mt-0"><button onClick={() => currentPlayingSong && currentPlayingSong.id === s.id ? stopPlayingSong() : playSong(s)} className={`px-1.5 py-0.5 text-xs rounded-md font-bold transition duration-300 ${currentPlayingSong && currentPlayingSong.id === s.id ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-purple-600 hover:bg-purple-700 text-white'}`}>{currentPlayingSong && currentPlayingSong.id === s.id ? 'Parar' : 'Tocar'}</button>{s.audioUrl && s.audioUrl.trim() !== '' && (<button onClick={() => window.open(s.audioUrl, '_blank')} className="px-1.5 py-0.5 text-xs bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300">Download</button>)}<button onClick={() => handleDeleteSong(s.id)} className="px-1.5 py-0.5 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300">Excluir</button></div></li>))}</ul>)}</div>);
        };

        // Componente Melhoria da Comunicação
        const CommunicationImprovement = ({ setView }) => {
          const tips = [
            { title: "Direto e Claro", description: "Use linguagem simples, evite sarcasmo ou metáforas.", videoUrl: "https://www.youtube.com/watch?v=9nzZq49tDrA" },
            { title: "Apoios Visuais", description: "Imagens, diagramas ou listas ajudam a transmitir informações.", videoUrl: "https://www.youtube.com/watch?v=XkE0-B6Tnxc" },
            { title: "Tempo para Processar", description: "Permita tempo extra para processar e responder.", videoUrl: "https://www.youtube.com/watch?v=9hCM3dXisM4" },
            { title: "Valide Sentimentos", description: "Reconheça emoções, mesmo que não as compreenda totalmente.", videoUrl: "https://m.youtube.com/watch?v=tPSO6hGCq3E" },
            { title: "Evite Sobrecarga", description: "Procure locais calmos, evite muitos estímulos.", videoUrl: "https://www.youtube.com/watch?v=w49aqf15bHs" },
            { title: "Peça Esclarecimentos", description: "Se não tiver certeza, peça para repetir ou explicar.", videoUrl: "https://www.youtube.com/watch?v=GLP_6LHL1dk" },
            { title: "Um Tópico por Vez", description: "Mantenha a conversa focada em um tópico.", videoUrl: "https://www.youtube.com/watch?v=EM7NxTVDyt8" },
            { title: "Sinais Não-Verbais", description: "Observe gestos e expressões, mas lembre-se que eles podem ser diferentes.", videoUrl: "https://www.youtube.com/watch?v=vwOKr40LOJI" },
          ];
          return (<div className="p-3 sm:p-4 bg-white rounded-lg shadow-lg"><button onClick={() => setView('home')} className="mb-3 px-3 py-1.5 text-sm bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Voltar</button><h2 className="text-lg sm:text-xl font-bold text-blue-700 mb-2">Melhorar Comunicação</h2><p className="text-xs sm:text-sm text-gray-700 mb-3">Dicas e estratégias para **pessoas neurotípicas** se comunicarem de forma mais eficaz e compreensiva com indivíduos com Transtorno do Espectro Autista (TEA) e Transtorno do Déficit de Atenção com Hiperatividade (TDAH). Clique em "Ver Vídeo Explicativo" para assistir a um vídeo relacionado.</p><div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3">{tips.map((t, i) => (<div key={i} className="bg-blue-50 p-2 rounded-lg shadow-md"><h3 className="text-sm sm:text-base font-semibold text-blue-800 mb-1">{t.title}</h3><p className="text-xs text-gray-700 mb-2">{t.description}</p>{t.videoUrl && (<button onClick={() => window.open(t.videoUrl, '_blank')} className="px-2 py-1 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300">Ver Vídeo Explicativo</button>)}</div>))}</div></div>);
        };

        // Componente para Pedido de Música Criativa
        const CreativeMusicRequest = ({ setView }) => {
            const [musicDescription, setMusicDescription] = React.useState(''); const [musicStyle, setMusicStyle] = React.useState('');
            const [voiceType, setVoiceType] = React.useState('noVoice'); const [userWhatsapp, setUserWhatsapp] = React.useState('');
            const [requestMessage, setRequestMessage] = React.useState('');

            const handleRequestMusic = () => {
                if (!musicDescription.trim() || !musicStyle.trim() || !userWhatsapp.trim()) { setRequestMessage("Preencha todos os campos."); return; }
                if (!/^\d{10,11}$/.test(userWhatsapp)) { setRequestMessage("Insira um WhatsApp válido (apenas dígitos, 10 ou 11 caracteres)."); return; }
                setRequestMessage(<div className="text-center mt-4 p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-lg"><p className="font-bold mb-2">Seu pedido de música criativa foi enviado!</p><p className="mb-2">Para que a música seja criada e enviada, por favor, faça um pagamento via Pix para a chave:</p><p className="font-bold text-lg mb-2">11082484970</p><p className="mb-2">Envie o comprovante de pagamento para o WhatsApp do dono do app:</p><p className="font-bold text-lg mb-2">42984242899</p><p className="text-sm">O valor a ser pago é o que você achar necessário pela criação da música.</p></div>);
                setMusicDescription(''); setMusicStyle(''); setVoiceType('noVoice'); setUserWhatsapp('');
            };

            return (<div className="p-3 sm:p-4 bg-white rounded-lg shadow-lg"><button onClick={() => setView('home')} className="mb-3 px-3 py-1.5 text-sm bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Voltar</button><h2 className="text-lg sm:text-xl font-bold text-blue-700 mb-2">Pedir Música Criativa</h2><p className="text-xs sm:text-sm text-gray-700 mb-3">Descreva a música dos seus sonhos e nós a criaremos para você!</p><div className="mb-3"><label htmlFor="musicDescription" className="block text-gray-700 text-xs font-bold mb-1">Descrição da Música:</label><textarea id="musicDescription" value={musicDescription} onChange={(e) => setMusicDescription(e.target.value)} placeholder="Ex: Uma melodia calma com sons da natureza para relaxar antes de dormir." rows="4" className="shadow border rounded w-full py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs" maxLength="500"></textarea></div><div className="mb-3"><label htmlFor="musicStyle" className="block text-gray-700 text-xs font-bold mb-1">Estilo da Música:</label><input type="text" id="musicStyle" value={musicStyle} onChange={(e) => setMusicStyle(e.target.value)} placeholder="Ex: Ambiente, Clássica, Eletrônica, Pop suave" className="shadow border rounded w-full py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs" maxLength="100" /></div><div className="mb-3"><label htmlFor="voiceType" className="block text-gray-700 text-xs font-bold mb-1">Tipo de Voz:</label><select id="voiceType" value={voiceType} onChange={(e) => setVoiceType(e.target.value)} className="shadow border rounded w-full py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs"><option value="noVoice">Sem Voz</option><option value="male">Voz Masculina</option><option value="female">Voz Feminina</option></select></div><div className="mb-4"><label htmlFor="userWhatsapp" className="block text-gray-700 text-xs font-bold mb-1">Seu WhatsApp (para envio da música):</label><input type="tel" id="userWhatsapp" value={userWhatsapp} onChange={(e) => setUserWhatsapp(e.target.value.replace(/\D/g, ''))} placeholder="Ex: 42984242899 (apenas números)" className="shadow border rounded w-full py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs" maxLength="11" /></div><button onClick={handleRequestMusic} className="px-3 py-1.5 text-sm bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 w-full">Pedir Música</button>{requestMessage && <div className="mt-4">{requestMessage}</div>}</div>);
        };

        // Componente Ajuda da IA
        const AIHelper = ({ setView }) => {
          const [difficulty, setDifficulty] = React.useState(''); const [youtubeLinks, setYoutubeLinks] = React.useState([]);
          const [loading, setLoading] = React.useState(false); const [message, setMessage] = React.useState('');

          const generateAndFetchLinks = async () => {
            if (!difficulty.trim()) { setMessage("Descreva sua dificuldade."); return; }
            setLoading(true); setMessage("Gerando sugestões de vídeos..."); setYoutubeLinks([]);
            try {
              const prompt = `Gere 3 termos de busca para o YouTube que ajudem uma pessoa com autismo a lidar com a seguinte dificuldade: "${difficulty}". Os termos devem ser focados em atividades ou exercícios práticos. Responda em formato JSON com uma chave "queries" que contém um array de strings.`;
              const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "queries": { type: "ARRAY", items: { type: "STRING" } } }, propertyOrdering: ["queries"] } } };
              const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              const r = await res.json();
              if (r.candidates?.[0]?.content?.parts?.[0]?.text) {
                const queries = JSON.parse(r.candidates[0].content.parts[0].text).queries;
                if (queries?.length > 0) { setYoutubeLinks(queries.map(q => ({ title: `Vídeo sobre "${q}"`, url: `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}` }))); setMessage("Sugestões de vídeos do YouTube:"); }
                else { setMessage("A IA não conseguiu gerar termos de busca relevantes."); }
              } else { setMessage("Erro ao processar a resposta da IA."); }
            } catch (e) { console.error("Erro ao gerar links do YouTube:", e); setMessage("Erro ao gerar sugestões."); }
            finally { setLoading(false); }
          };

          return (<div className="p-3 sm:p-4 bg-white rounded-lg shadow-lg"><button onClick={() => setView('home')} className="mb-3 px-3 py-1.5 text-sm bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Voltar</button><h2 className="text-lg sm:text-xl font-bold text-blue-700 mb-2">Ajuda da Inteligência Artificial ✨</h2><p className="text-xs sm:text-sm text-gray-700 mb-3">Descreva sua maior dificuldade e a IA irá sugerir vídeos do YouTube para ajudar.</p><div className="mb-2"><label htmlFor="difficulty" className="block text-gray-700 text-xs font-bold mb-1">Qual sua dificuldade?</label><textarea id="difficulty" value={difficulty} onChange={(e) => setDifficulty(e.target.value)} placeholder="Ex: Lidar com barulhos, iniciar tarefas." rows="3" className="shadow border rounded w-full py-1 px-2 text-gray-700 focus:outline-none focus:shadow-outline text-xs"></textarea></div><button onClick={generateAndFetchLinks} disabled={loading} className={`px-3 py-1.5 text-sm bg-blue-600 text-white font-bold rounded-lg shadow-md ${loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-700'} transition duration-300 w-full`}>Gerar Sugestões ✨</button>{message && <p className="text-center text-xs text-gray-600 mt-2">{message}</p>}{youtubeLinks.length > 0 && (<div className="mt-3"><h3 className="text-base sm:text-lg font-bold text-blue-700 mb-1">Vídeos Sugeridos:</h3><ul className="space-y-1.5">{youtubeLinks.map((l, i) => (<li key={i} className="bg-blue-50 p-2 rounded-lg shadow-sm"><a href={l.url} target="_blank" rel="noopener noreferrer" className="text-blue-700 hover:underline font-semibold text-xs sm:text-sm">{l.title}</a></li>))}</ul></div>)}</div>);
        };

        // Componente principal do aplicativo
        const App = () => {
          const [view, setView] = React.useState('home');
          return (<AppProvider><div className="min-h-screen bg-blue-100 p-2 flex flex-col items-center"><HeaderTitle /><main className="mt-2 w-full max-w-full sm:max-w-4xl pb-16">{view === 'home' && <Home setView={setView} />}{view === 'binaural' && <BinauralGenerator setView={setView} />}{view === 'routine' && <DailyRoutine setView={setView} />}{view === 'selfAssessment' && <SelfAssessment setView={setView} />}{view === 'soundLibrary' && <SoundLibrary setView={setView} />}{view === 'userPlaylist' && <UserPlaylist setView={setView} />}{view === 'communication' && <CommunicationImprovement setView={setView} />}{view === 'aiHelper' && <AIHelper setView={setView} />}{view === 'creativeMusicRequest' && <CreativeMusicRequest setView={setView} />}</main><FooterNav /></div></AppProvider>);
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

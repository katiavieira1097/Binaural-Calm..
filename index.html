<!DOCTYPE html>
<html Lang="pr-BR>"
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binaural Calm App</title>
    html
    <link rel="manifest"
        href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e0f2fe; color: #1e3a8a; padding-top: 4rem; min-height: 100vh; }
        .container { margin: 0 auto; padding: 1.5rem; background-color: transparent; }
        section { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); margin-bottom: 2rem; padding: 1.5rem; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; transition: background-color 0.2s, transform 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #6366f1; color: white; } .btn-primary:hover { background-color: #4f46e5; transform: translateY(-2px); }
        .btn-secondary { background-color: #e2e8f0; color: #475569; } .btn-secondary:hover { background-color: #cbd5e1; transform: translateY(-2px); }
        .input-range { width: 100%; height: 8px; background: #cbd5e1; border-radius: 4px; outline: none; -webkit-appearance: none; appearance: none; cursor: pointer; }
        .input-range::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #6366f1; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .input-range::-moz-range-thumb { width: 20px; height: 20px; background: #6366f1; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; } .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .loading-spinner { border: 4px solid rgba(0,0,0,0.1); border-left-color: #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
        .sound-card { background-color: #fff; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); padding: 1rem; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .sound-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .sound-card-icon { font-size: 2.5rem; margin-bottom: 0.5rem; color: #4f46e5; }
        #startScreen { background-image: url('https://raw.githubusercontent.com/google-gemini/gemini-web-ai-examples/main/images/1751854280319%20(1).jpg'); background-size: cover; background-position: center; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: #e0f2fe; position: relative; background-color: #f0f4f8; }
        #startScreen::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1; }
        #startScreen > * { z-index: 2; }
        .start-screen-title { font-size: 3.5rem; font-weight: 700; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); color: #e0f2fe; }
        .start-screen-description { font-size: 1.25rem; margin-bottom: 2rem; max-width: 600px; color: #d0e8ff; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .start-screen-button { background-color: rgba(99,102,241,0.9); color: white; padding: 1rem 2.5rem; border-radius: 0.75rem; font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; transition: background-color 0.2s, transform 0.2s; cursor: pointer; border: 2px solid white; }
        .start-screen-button:hover { background-color: rgba(79,70,229,0.9); transform: translateY(-3px); }
        .music-card { background-color: #fff; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        .music-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 0.75rem; }
        .music-card h4 { font-weight: 600; color: #334155; margin-bottom: 0.25rem; }
        .music-card p { font-size: 0.875rem; color: #64748b; margin-bottom: 0.75rem; }
        .music-card button { background-color: #8b5cf6; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; transition: background-color 0.2s; }
        .music-card button:hover { background-color: #7c3aed; }
        .add-to-playlist-modal-content { background-color: #fefefe; padding: 20px; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 500px; text-align: left; }
        .add-to-playlist-modal-content h3 { text-align: center; margin-bottom: 1.5rem; }
        .add-to-playlist-modal-content label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .add-to-playlist-modal-content select, .add-to-playlist-modal-content input[type="checkbox"] { margin-bottom: 1rem; }
        .add-to-playlist-modal-content .checkbox-item { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .add-to-playlist-modal-content .checkbox-item input { margin-right: 0.75rem; }
        .navbar { position: fixed; top: 0; left: 0; width: 100%; background-color: #4f46e5; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); z-index: 500; display: flex; justify-content: center; padding: 0.5rem 1rem; flex-wrap: wrap; }
        .navbar a { color: white; padding: 0.5rem 1rem; margin: 0.25rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.2s, transform 0.2s; text-decoration: none; }
        .navbar a:hover { background-color: #6366f1; transform: translateY(-1px); }
        section { padding-top: 5rem; margin-top: -4rem; }
        .routine-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .routine-table th, .routine-table td { border: 1px solid #a7d9f7; padding: 0.75rem; text-align: left; color: #1e3a8a; }
        .routine-table th { background-color: #cce7fa; font-weight: 600; color: #1e3a8a; }
        .routine-table tr:nth-child(even) { background-color: #eaf6ff; }
        .routine-table button { padding: 0.3rem 0.6rem; font-size: 0.875rem; border-radius: 0.5rem; }
    </style>
</head>
<body class="p-0">
    <div id="startScreen" class="w-full h-full absolute top-0 left-0">
        <img src="https://raw.githubusercontent.com/google-gemini/gemini-web-ai-examples/main/images/1751854280319%20(1).jpg" alt="Capa Binaural Calm" class="absolute inset-0 w-full h-full object-cover z-0">
        <div class="absolute inset-0 bg-black opacity-50 z-10"></div>
        <h1 class="start-screen-title relative z-20">Binaural Calm</h1>
        <p class="start-screen-description relative z-20 px-4">Seu refúgio diário para sons que acalmam, focam e inspiram. Descubra a paz e o bem-estar.</p>
        <button id="enterAppButton" class="start-screen-button relative z-20">Entrar no App</button>
    </div>

    <div id="mainAppContent" class="hidden">
        <nav class="navbar">
            <a href="#binauralGeneratorSection">Binaural</a>
            <a href="#soundLibrarySection">Biblioteca</a>
            <a href="#aiQnASection">Perguntas IA</a>
            <a href="#selfAssessmentSection">Autoavaliação</a>
            <a href="#myMusicSection">Minhas Músicas</a>
            <a href="#myPlaylistsSection">Playlists</a>
            <a href="#dailyRoutineSection">Rotina Diária</a>
            <a href="#supportSection">Suporte</a>
        </nav>

        <div class="container p-4 sm:p-6 lg:p-8">
            <h1 class="text-3xl font-bold text-center mb-6 text-indigo-700">Binaural Calm App</h1>
            <p class="text-center text-sm text-gray-500 mb-6">ID do Usuário: <span id="userIdDisplay">Carregando...</span></p>

            <section id="binauralGeneratorSection" class="p-6 bg-indigo-50 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Gerador de Sons Binaurais</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div><label for="baseFrequencyRange" class="block text-lg font-medium text-gray-700 mb-2">Frequência Base: <span id="baseFrequencyValue">440</span> Hz</label><input type="range" id="baseFrequencyRange" min="200" max="1000" value="440" class="input-range"></div>
                    <div><label for="beatFrequencyRange" class="block text-lg font-medium text-gray-700 mb-2">Frequência Binaural: <span id="beatFrequencyValue">5</span> Hz</label><input type="range" id="beatFrequencyRange" min="1" max="30" value="5" class="input-range"></div>
                </div>
                <div class="flex flex-wrap gap-2 mt-4">
                    <button id="playBinauralButton" class="btn btn-primary">Tocar Binaural</button>
                    <button id="stopBinauralButton" class="btn btn-secondary" disabled>Parar</button>
                    <button id="downloadBinauralButton" class="btn btn-secondary" disabled>Baixar (WAV)</button>
                </div>
                <p class="text-sm text-gray-600 mt-4">Nota: O download é em formato WAV.</p>
            </section>

            <section id="soundLibrarySection" class="p-6 bg-yellow-50 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-yellow-600">Biblioteca de Sons</h2>
                <p class="text-sm text-gray-600 mb-4">Ouça sons e músicas pré-selecionados. Para baixar, acesse a plataforma de origem!</p>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="soundLibrary"></div>
            </section>

            <section id="aiQnASection" class="p-6 bg-blue-50 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-blue-600">Perguntas e Respostas com IA (YouTube)</h2>
                <div class="mb-4"><label for="aiQuestion" class="block text-lg font-medium text-gray-700 mb-2">Faça sua pergunta:</label><textarea id="aiQuestion" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Ex: Como lidar com a ansiedade no TDAH?"></textarea></div>
                <button id="askAiButton" class="btn btn-primary w-full md:w-auto"><span id="askAiSpinner" class="loading-spinner hidden mr-2"></span>Perguntar à IA</button>
                <div id="aiResponse" class="mt-4 p-4 bg-blue-100 rounded-lg border border-blue-200 hidden"><p class="font-semibold text-blue-800 mb-2">Resposta da IA:</p><div id="aiResponseContent" class="text-gray-700"></div></div>
            </section>

            <section id="selfAssessmentSection" class="p-6 bg-green-50 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-green-600">Autoavaliação e Metas</h2>
                <div class="mb-4"><label for="behaviorDescription" class="block text-lg font-medium text-gray-700 mb-2">Descreva seu comportamento ou dificuldade:</label><textarea id="behaviorDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" rows="4" placeholder="Ex: Tenho dificuldade em manter o foco em tarefas longas."></textarea></div>
                <button id="getAiFeedbackButton" class="btn btn-primary w-full md:w-auto mb-4"><span id="feedbackSpinner" class="loading-spinner hidden mr-2"></span>Obter Feedback da IA</button>
                <div id="aiFeedbackResponse" class="mt-4 p-4 bg-green-100 rounded-lg border border-green-200 hidden"><p class="font-semibold text-green-800 mb-2">Resposta da IA:</p><div id="aiFeedbackContent" class="text-gray-700"></div></div>
                <div class="mt-6"><label for="weeklyGoal" class="block text-lg font-medium text-gray-700 mb-2">Minha Meta Semanal:</label><input type="text" id="weeklyGoal" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="Ex: Concluir 3 tarefas sem interrupções."></div>
                <button id="completeGoalButton" class="btn btn-primary w-full md:w-auto mt-4">Etapa Concluída</button>
            </section>

            <section id="myMusicSection" class="p-6 bg-purple-50 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-purple-600">Minhas Músicas</h2>
                <div id="addMusicSection" class="hidden p-4 bg-purple-100 rounded-lg mb-4">
                    <h3 class="text-xl font-semibold mb-3 text-purple-700">Adicionar Músicas (Recompensa!)</h3>
                    <p class="text-sm text-gray-600 mb-3"><strong class="font-bold text-red-700">Atenção:</strong> Músicas temporárias. Recarregue ao abrir o app.</p>
                    <div class="mb-2"><label for="localAudioFile" class="block text-sm font-medium text-gray-700">Arquivo de Áudio:</label><input type="file" id="localAudioFile" accept="audio/*" class="w-full p-2 border border-gray-300 rounded-md"></div>
                    <div class="mb-4"><label for="localCoverFile" class="block text-sm font-medium text-gray-700">Capa (Opcional):</label><input type="file" id="localCoverFile" accept="image/*" class="w-full p-2 border border-gray-300 rounded-md"></div>
                    <button id="addLocalMusicButton" class="btn btn-primary w-full md:w-auto">Adicionar Música Local</button>
                </div>
                <div id="mySongsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <p id="noSongsMessage" class="text-gray-500 text-center col-span-full">Nenhuma música adicionada ainda.</p>
            </section>

            <section id="myPlaylistsSection" class="p-6 bg-pink-50 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-pink-600">Minhas Playlists</h2>
                <p class="text-sm text-gray-600 mb-4"><strong class="font-bold text-red-700">Atenção:</strong> Músicas precisam ser recarregadas localmente a cada sessão.</p>
                <div class="mb-4"><label for="newPlaylistName" class="block text-lg font-medium text-gray-700 mb-2">Nome da Nova Playlist:</label><input type="text" id="newPlaylistName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500" placeholder="Minha Playlist Relaxante"></div>
                <button id="createPlaylistButton" class="btn btn-primary mt-3">Criar Playlist</button>
                <div id="playlistsList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                <p id="noPlaylistsMessage" class="text-gray-500 text-center col-span-full">Nenhuma playlist criada ainda.</p>
            </section>

            <section id="dailyRoutineSection" class="p-6 bg-blue-100 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-blue-700">Minha Rotina Diária</h2>
                <p class="text-sm text-gray-600 mb-4"><strong class="font-bold text-red-700">Atenção Importante:</strong><ul class="list-disc list-inside ml-4 text-red-700"><li>Notificações com música **só funcionarão se o app estiver aberto e em primeiro plano**.</li><li>Músicas de alarme carregadas são **temporárias**. Recarregue ao abrir o app.</li></ul></p>
                <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-xl font-semibold mb-3 text-blue-600">Adicionar Nova Tarefa</h3>
                    <div class="mb-2"><label for="routineTaskName" class="block text-sm font-medium text-gray-700">Tarefa:</label><input type="text" id="routineTaskName" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Meditar, Beber água"></div>
                    <div class="mb-2"><label for="routineTaskTime" class="block text-sm font-medium text-gray-700">Horário:</label><input type="time" id="routineTaskTime" class="w-full p-2 border border-gray-300 rounded-md"></div>
                    <div class="mb-2"><label for="routineTaskPeriod" class="block text-sm font-medium text-gray-700">Período:</label><select id="routineTaskPeriod" class="w-full p-2 border border-gray-300 rounded-md"><option value="morning">Manhã (00:00 - 11:59)</option><option value="afternoon">Tarde (12:00 - 17:59)</option><option value="night">Noite (18:00 - 23:59)</option></select></div>
                    <div class="mb-4"><label for="routineAlarmMusicFile" class="block text-sm font-medium text-gray-700">Música para Alarme (do seu celular, Opcional):</label><input type="file" id="routineAlarmMusicFile" accept="audio/*" class="w-full p-2 border border-gray-300 rounded-md"></div>
                    <button id="addRoutineTaskButton" class="btn btn-primary w-full md:w-auto">Adicionar Tarefa</button>
                </div>
                <h3 class="text-xl font-semibold mb-2 text-blue-600">Manhã</h3><table class="routine-table mb-6"><thead><tr><th>Tarefa</th><th>Horário</th><th>Música do Alarme</th><th>Ações</th></tr></thead><tbody id="routineTableBodyMorning"><tr><td colspan="4" class="text-center text-gray-500" id="noRoutineTasksMessageMorning">Nenhuma tarefa para a manhã.</td></tr></tbody></table>
                <h3 class="text-xl font-semibold mb-2 text-blue-600">Tarde</h3><table class="routine-table mb-6"><thead><tr><th>Tarefa</th><th>Horário</th><th>Música do Alarme</th><th>Ações</th></tr></thead><tbody id="routineTableBodyAfternoon"><tr><td colspan="4" class="text-center text-gray-500" id="noRoutineTasksMessageAfternoon">Nenhuma tarefa para a tarde.</td></tr></tbody></table>
                <h3 class="text-xl font-semibold mb-2 text-blue-600">Noite</h3><table class="routine-table mb-6"><thead><tr><th>Tarefa</th><th>Horário</th><th>Música do Alarme</th><th>Ações</th></tr></thead><tbody id="routineTableBodyNight"><tr><td colspan="4" class="text-center text-gray-500" id="noRoutineTasksMessageNight">Nenhuma tarefa para a noite.</td></tr></tbody></table>
            </section>

            <section id="supportSection" class="p-6 bg-gray-100 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Dúvidas e Suporte</h2>
                <p class="text-gray-700 mb-4">Tem alguma dúvida, sugestão ou encontrou um problema? Envie um e-mail para nossa equipe de suporte!</p>
                <p class="text-lg font-bold text-blue-700 mb-4">E-mail: <a href="mailto:katiavieira1097@gmail.com" class="hover:underline">katiavieira1097@gmail.com</a></p>
            </section>
        </div>
    </div>

    <div id="messageModal" class="modal"><div class="modal-content"><span class="close-button-message-modal close-button">&times;</span><p id="modalMessage" class="text-lg text-gray-800"></p><button class="btn btn-primary mt-4 close-button-message-modal">Ok</button></div></div>
    <div id="addSongsToPlaylistModal" class="modal"><div class="add-to-playlist-modal-content"><span class="close-button-add-playlist-modal close-button">&times;</span><h3 class="text-xl font-bold text-pink-700 mb-4">Adicionar Músicas à Playlist</h3><p class="text-gray-700 mb-4">Selecione as músicas que deseja adicionar a esta playlist:</p><div id="availableSongsForPlaylist" class="mb-4"></div><button id="confirmAddSongsToPlaylistButton" class="btn btn-primary w-full">Confirmar</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot, query, orderBy, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let audioContext, oscillatorLeft, oscillatorRight, gainNodeLeft, gainNodeRight, isPlaying = false, currentPlayingAudio = null, currentPlaylistPlaying = null, currentPlaylistIndex = 0, alarmTimeouts = {};
        const MAX_SONGS_PER_GOAL = 5;
        const startScreen = document.getElementById('startScreen'), mainAppContent = document.getElementById('mainAppContent'), enterAppButton = document.getElementById('enterAppButton');
        const baseFrequencyRange = document.getElementById('baseFrequencyRange'), baseFrequencyValueSpan = document.getElementById('baseFrequencyValue'), beatFrequencyRange = document.getElementById('beatFrequencyRange'), beatFrequencyValueSpan = document.getElementById('beatFrequencyValue'), playBinauralButton = document.getElementById('playBinauralButton'), stopBinauralButton = document.getElementById('stopBinauralButton'), downloadBinauralButton = document.getElementById('downloadBinauralButton');
        const aiQuestionInput = document.getElementById('aiQuestion'), askAiButton = document.getElementById('askAiButton'), aiResponseDiv = document.getElementById('aiResponse'), aiResponseContent = document.getElementById('aiResponseContent'), askAiSpinner = document.getElementById('askAiSpinner');
        const behaviorDescriptionInput = document.getElementById('behaviorDescription'), getAiFeedbackButton = document.getElementById('getAiFeedbackButton'), aiFeedbackResponseDiv = document.getElementById('aiFeedbackResponse'), aiFeedbackContent = document.getElementById('aiFeedbackContent'), feedbackSpinner = document.getElementById('feedbackSpinner');
        const weeklyGoalInput = document.getElementById('weeklyGoal'), completeGoalButton = document.getElementById('completeGoalButton');
        const addMusicSection = document.getElementById('addMusicSection'), localAudioFile = document.getElementById('localAudioFile'), localCoverFile = document.getElementById('localCoverFile'), addLocalMusicButton = document.getElementById('addLocalMusicButton'), mySongsList = document.getElementById('mySongsList'), noSongsMessage = document.getElementById('noSongsMessage');
        const newPlaylistNameInput = document.getElementById('newPlaylistName'), createPlaylistButton = document.getElementById('createPlaylistButton'), playlistsList = document.getElementById('playlistsList'), noPlaylistsMessage = document.getElementById('noPlaylistsMessage'), addSongsToPlaylistModal = document.getElementById('addSongsToPlaylistModal'), availableSongsForPlaylist = document.getElementById('availableSongsForPlaylist'), confirmAddSongsToPlaylistButton = document.getElementById('confirmAddSongsToPlaylistButton');
        const soundLibraryDiv = document.getElementById('soundLibrary');
        const routineTaskNameInput = document.getElementById('routineTaskName'), routineTaskTimeInput = document.getElementById('routineTaskTime'), routineTaskPeriodSelect = document.getElementById('routineTaskPeriod'), routineAlarmMusicFileInput = document.getElementById('routineAlarmMusicFile'), addRoutineTaskButton = document.getElementById('addRoutineTaskButton');
        const routineTableBodyMorning = document.getElementById('routineTableBodyMorning'), routineTableBodyAfternoon = document.getElementById('routineTableBodyAfternoon'), routineTableBodyNight = document.getElementById('routineTableBodyNight');
        const noRoutineTasksMessageMorning = document.getElementById('noRoutineTasksMessageMorning'), noRoutineTasksMessageAfternoon = document.getElementById('noRoutineTasksMessageAfternoon'), noRoutineTasksMessageNight = document.getElementById('noRoutineTasksMessageNight');
        let app, db, auth, userId, playlistsCollectionRef, dailyRoutinesCollectionRef;
        let songsAddedThisGoal = 0, allUserSongs = [], allUserPlaylists = [], allDailyRoutines = [];
        let routineAlarmMusicUrls = {};

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        function showModal(msg, id = 'messageModal') {
            const modal = document.getElementById(id);
            if (id === 'messageModal') modal.querySelector('#modalMessage').textContent = msg;
            modal.style.display = 'flex';
        }
        function showScreen(id) {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('mainAppContent').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }
        function createAudioContext() { if (!audioContext || audioContext.state === 'closed') audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
        function playBinauralSound() {
            stopAllAudio(); createAudioContext();
            const baseF = parseFloat(baseFrequencyRange.value), beatF = parseFloat(beatFrequencyRange.value);
            oscillatorLeft = audioContext.createOscillator(); oscillatorLeft.type = 'sine'; oscillatorLeft.frequency.setValueAtTime(baseF, audioContext.currentTime);
            gainNodeLeft = audioContext.createGain(); gainNodeLeft.gain.value = 0.5; oscillatorLeft.connect(gainNodeLeft);
            const panNodeLeft = audioContext.createStereoPanner(); panNodeLeft.pan.setValueAtTime(-1, audioContext.currentTime); gainNodeLeft.connect(panNodeLeft); panNodeLeft.connect(audioContext.destination);
            oscillatorRight = audioContext.createOscillator(); oscillatorRight.type = 'sine'; oscillatorRight.frequency.setValueAtTime(baseF + beatF, audioContext.currentTime);
            gainNodeRight = audioContext.createGain(); gainNodeRight.gain.value = 0.5; oscillatorRight.connect(gainNodeRight);
            const panNodeRight = audioContext.createStereoPanner(); panNodeRight.pan.setValueAtTime(1, audioContext.currentTime); gainNodeRight.connect(panNodeRight); panNodeRight.connect(audioContext.destination);
            oscillatorLeft.start(); oscillatorRight.start();
            isPlaying = true; playBinauralButton.disabled = true; stopBinauralButton.disabled = false; downloadBinauralButton.disabled = false;
            showModal(`Sons binaurais iniciados: Base ${baseF} Hz, Batida ${beatF} Hz.`);
        }
        function stopBinauralSound() {
            if (!isPlaying) return;
            if (oscillatorLeft) { oscillatorLeft.stop(); oscillatorLeft.disconnect(); oscillatorLeft = null; }
            if (oscillatorRight) { oscillatorRight.stop(); oscillatorRight.disconnect(); oscillatorRight = null; }
            if (gainNodeLeft) gainNodeLeft.disconnect(); if (gainNodeRight) gainNodeRight.disconnect();
            if (audioContext && audioContext.state !== 'closed') audioContext.close().then(() => { audioContext = null; });
            isPlaying = false; playBinauralButton.disabled = false; stopBinauralButton.disabled = true; downloadBinauralButton.disabled = true;
            showModal("Sons binaurais parados.");
        }
        async function downloadBinauralAudio() {
            if (!audioContext) { showModal("Nenhum som binaural para baixar. Toque o som primeiro."); return; }
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const sampleRate = ctx.sampleRate, duration = 10, numFrames = sampleRate * duration;
            const buffer = ctx.createBuffer(2, numFrames, sampleRate);
            const baseF = parseFloat(baseFrequencyRange.value), beatF = parseFloat(beatFrequencyRange.value);
            const chLeft = buffer.getChannelData(0), chRight = buffer.getChannelData(1);
            for (let i = 0; i < numFrames; i++) { const time = i / sampleRate; chLeft[i] = Math.sin(2 * Math.PI * baseF * time) * 0.5; chRight[i] = Math.sin(2 * Math.PI * (baseF + beatF) * time) * 0.5; }
            const wavBlob = bufferToWav(buffer);
            const url = URL.createObjectURL(wavBlob); const a = document.createElement('a'); a.href = url; a.download = `binaural-${baseF}Hz-${beatF}beat.wav`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showModal(`Áudio binaural (${baseF}Hz + ${beatF}Hz) baixado!`);
        }
        function bufferToWav(buffer) {
            const numCh = buffer.numberOfChannels, sr = buffer.sampleRate, format = 1, bd = 16;
            let interleaved = []; for (let i = 0; i < buffer.getChannelData(0).length; i++) { for (let ch = 0; ch < numCh; ch++) { interleaved.push(buffer.getChannelData(ch)[i]); } }
            const dv = new DataView(new ArrayBuffer(44 + interleaved.length * 2)); let off = 0;
            function ws(v, o, s) { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)); }
            function u16(v, o, val) { v.setUint16(o, val, true); }
            function u32(v, o, val) { v.setUint32(o, val, true); }
            ws(dv, off, 'RIFF'); off += 4; u32(dv, off, 36 + interleaved.length * 2); off += 4; ws(dv, off, 'WAVE'); off += 4;
            ws(dv, off, 'fmt '); off += 4; u32(dv, off, 16); off += 4; u16(dv, off, format); off += 2; u16(dv, off, numCh); off += 2; u32(dv, off, sr); off += 4; u32(dv, off, sr * numCh * (bd / 8)); off += 4; u16(dv, off, numCh * (bd / 8)); off += 2; u16(dv, off, bd); off += 2;
            ws(dv, off, 'data'); off += 4; u32(dv, off, interleaved.length * 2); off += 4;
            for (let i = 0; i < interleaved.length; i++, off += 2) { const s = Math.max(-1, Math.min(1, interleaved[i])); dv.setInt16(off, s < 0 ? s * 0x8000 : s * 0x7FFF, true); }
            return new Blob([dv], { type: 'audio/wav' });
        }
        function playUserLocalSong(url) {
            stopAllAudio(); if (!url) { showModal("URL de áudio local não fornecida."); return; }
            currentPlayingAudio = new Audio(url); currentPlayingAudio.volume = 0.5;
            currentPlayingAudio.play().then(() => { isPlaying = true; playBinauralButton.disabled = true; stopBinauralButton.disabled = false; downloadBinauralButton.disabled = true; showModal("Música local iniciada."); })
                .catch(err => { console.error("Erro ao tocar:", err); showModal("Não foi possível tocar esta música. Verifique a URL ou CORS."); isPlaying = false; playBinauralButton.disabled = false; stopBinauralButton.disabled = true; });
        }
        async function playPlaylist(id) {
            stopAllAudio(); const pl = allUserPlaylists.find(p => p.id === id);
            if (!pl || pl.songs.length === 0) { showModal("Playlist vazia ou não encontrada."); return; }
            currentPlaylistPlaying = pl; currentPlaylistIndex = 0; playNextSongInPlaylist();
        }
        function playNextSongInPlaylist() {
            if (!currentPlaylistPlaying || currentPlaylistIndex >= currentPlaylistPlaying.songs.length) { showModal("Fim da playlist."); currentPlaylistPlaying = null; currentPlaylistIndex = 0; stopAllAudio(); return; }
            const song = allUserSongs.find(s => s.id === currentPlaylistPlaying.songs[currentPlaylistIndex]);
            if (song && song.audioFileUrl) { playUserLocalSong(song.audioFileUrl); currentPlayingAudio.onended = () => { currentPlaylistIndex++; playNextSongInPlaylist(); }; showModal(`Tocando: ${currentPlaylistPlaying.name} - ${song.name || 'Música Local'}`); }
            else { showModal(`Música na playlist (ID: ${currentPlaylistPlaying.songs[currentPlaylistIndex]}) não encontrada. Pulando.`); currentPlaylistIndex++; playNextSongInPlaylist(); }
        }
        function stopAllAudio() {
            if (oscillatorLeft) { oscillatorLeft.stop(); oscillatorLeft.disconnect(); oscillatorLeft = null; }
            if (oscillatorRight) { oscillatorRight.stop(); oscillatorRight.disconnect(); oscillatorRight = null; }
            if (gainNodeLeft) gainNodeLeft.disconnect(); if (gainNodeRight) gainNodeRight.disconnect();
            if (currentPlayingAudio) { currentPlayingAudio.pause(); currentPlayingAudio.currentTime = 0; currentPlayingAudio = null; }
            if (audioContext && audioContext.state !== 'closed') audioContext.close().then(() => { audioContext = null; });
            isPlaying = false; playBinauralButton.disabled = false; stopBinauralButton.disabled = true; downloadBinauralButton.disabled = true;
            currentPlaylistPlaying = null; currentPlaylistIndex = 0;
        }
        async function callGeminiApi(prompt, spinner, resDiv, resContent) {
            spinner.classList.remove('hidden'); resDiv.classList.add('hidden'); resContent.innerHTML = '';
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] }, apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const res = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    resContent.innerHTML = result.candidates[0].content.parts[0].text.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target="_blank" class="text-indigo-600 hover:underline">${url}</a>`);
                    resDiv.classList.remove('hidden');
                } else { showModal("Não foi possível obter uma resposta da IA."); }
            } catch (e) { console.error("Erro na API Gemini:", e); showModal("Erro ao comunicar com a IA."); } finally { spinner.classList.add('hidden'); }
        }
        async function initializeFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            if (Object.keys(firebaseConfig).length === 0) { console.error("Firebase config não disponível."); showModal("Erro: Configuração do Firebase não encontrada."); return; }
            app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) userId = user.uid;
                else { try { if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); userId = auth.currentUser?.uid || crypto.randomUUID(); }
                catch (e) { console.error("Erro autenticação Firebase:", e); userId = crypto.randomUUID(); showModal("Erro ao autenticar. Funcionalidades limitadas."); } }
                document.getElementById('userIdDisplay').textContent = userId;
                playlistsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/playlists`);
                dailyRoutinesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/dailyRoutines`);
                renderUserSongs(); setupPlaylistsListener(); setupDailyRoutinesListener(); showScreen('mainAppContent');
            });
        }
        function addLocalMusic() {
            const audioFile = localAudioFile.files[0], coverFile = localCoverFile.files[0];
            if (!audioFile) { showModal("Selecione um arquivo de áudio."); return; }
            if (songsAddedThisGoal >= MAX_SONGS_PER_GOAL) { showModal(`Você já adicionou ${MAX_SONGS_PER_GOAL} músicas. Complete outra meta.`); return; }
            const audioUrl = URL.createObjectURL(audioFile), coverUrl = coverFile ? URL.createObjectURL(coverFile) : '';
            allUserSongs.push({ id: crypto.randomUUID(), name: audioFile.name.split('.').slice(0, -1).join('.'), artist: 'Desconhecido', audioFileUrl: audioUrl, coverUrl: coverUrl });
            songsAddedThisGoal++; renderUserSongs(); showModal(`Música "${audioFile.name}" adicionada!`);
            localAudioFile.value = ''; localCoverFile.value = '';
        }
        function renderUserSongs() {
            mySongsList.innerHTML = '';
            if (allUserSongs.length === 0) noSongsMessage.style.display = 'block'; else { noSongsMessage.style.display = 'none'; allUserSongs.forEach(s => { mySongsList.innerHTML += `<div class="music-card"><img src="${s.coverUrl || 'https://placehold.co/100x100/e2e8f0/475569?text=Capa'}" alt="Capa"><h4>${s.name}</h4><p>${s.artist}</p><button class="play-user-music-btn" data-song-id="${s.id}">Tocar</button></div>`; }); }
            document.querySelectorAll('.play-user-music-btn').forEach(b => b.addEventListener('click', e => { const s = allUserSongs.find(s => s.id === e.target.dataset.songId); if (s?.audioFileUrl) playUserLocalSong(s.audioFileUrl); else showModal("URL de áudio não encontrada."); }));
        }
        function setupPlaylistsListener() {
            if (!playlistsCollectionRef) return;
            onSnapshot(query(playlistsCollectionRef, orderBy("createdAt", "desc")), (snap) => {
                playlistsList.innerHTML = ''; allUserPlaylists = [];
                if (snap.empty) noPlaylistsMessage.style.display = 'block';
                else { noPlaylistsMessage.style.display = 'none'; snap.forEach(d => { const pl = { id: d.id, ...d.data() }; allUserPlaylists.push(pl); playlistsList.innerHTML += `<div class="bg-white p-4 rounded-lg shadow"><h4 class="font-semibold text-gray-800 mb-2">${pl.name}</h4><p class="text-sm text-gray-600 mb-3">${pl.songs.length} músicas</p><button class="btn btn-secondary text-xs py-1 px-2 mr-2 add-to-playlist-btn" data-playlist-id="${pl.id}">Adicionar Músicas</button><button class="btn btn-primary text-xs py-1 px-2 play-playlist-btn" data-playlist-id="${pl.id}">Tocar Playlist</button></div>`; }); }
                document.querySelectorAll('.add-to-playlist-btn').forEach(b => b.addEventListener('click', e => openAddSongsToPlaylistModal(e.target.dataset.playlistId)));
                document.querySelectorAll('.play-playlist-btn').forEach(b => b.addEventListener('click', e => playPlaylist(e.target.dataset.playlistId)));
            });
        }
        async function createPlaylist() {
            const name = newPlaylistNameInput.value.trim(); if (!name) { showModal("Digite um nome para a playlist."); return; }
            if (!userId) { showModal("Erro: Usuário não autenticado."); return; }
            try { await addDoc(playlistsCollectionRef, { name: name, songs: [], createdAt: serverTimestamp(), userId: userId }); showModal(`Playlist "${name}" criada!`); newPlaylistNameInput.value = ''; }
            catch (e) { console.error("Erro ao criar playlist: ", e); showModal("Erro ao criar a playlist."); }
        }
        let currentPlaylistIdToAddSongs = null;
        function openAddSongsToPlaylistModal(id) {
            currentPlaylistIdToAddSongs = id; availableSongsForPlaylist.innerHTML = '';
            const pl = allUserPlaylists.find(p => p.id === id); const plSongIds = pl ? new Set(pl.songs) : new Set();
            if (allUserSongs.length === 0) availableSongsForPlaylist.innerHTML = '<p class="text-gray-500">Sem músicas locais para adicionar.</p>';
            else allUserSongs.forEach(s => { availableSongsForPlaylist.innerHTML += `<div class="checkbox-item"><input type="checkbox" id="song-${s.id}" value="${s.id}" ${plSongIds.has(s.id) ? 'checked' : ''}><label for="song-${s.id}">${s.name} - ${s.artist}</label></div>`; });
            showModal('', 'addSongsToPlaylistModal');
        }
        async function confirmAddSongsToPlaylist() {
            if (!currentPlaylistIdToAddSongs) return;
            const selIds = []; document.querySelectorAll('#availableSongsForPlaylist input[type="checkbox"]:checked').forEach(cb => selIds.push(cb.value));
            try { await updateDoc(doc(db, `artifacts/${app.options.appId}/users/${userId}/playlists`, currentPlaylistIdToAddSongs), { songs: selIds }); showModal("Músicas adicionadas à playlist!"); closeModal('addSongsToPlaylistModal'); }
            catch (e) { console.error("Erro ao adicionar músicas:", e); showModal("Erro ao adicionar músicas à playlist."); }
        }
        const soundCategories = [
            { id: 's1', name: 'Som 1', icon: '🎵', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', platformUrl: 'https://www.soundhelix.com/audio-examples' },
            { id: 's2', name: 'Som 2', icon: '🎶', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', platformUrl: 'https://www.soundhelix.com/audio-examples' },
            { id: 's3', name: 'Som 3', icon: '🎧', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', platformUrl: 'https://www.soundhelix.com/audio-examples' },
            { id: 's4', name: 'Som 4', icon: '🎼', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', platformUrl: 'https://www.soundhelix.com/audio-examples' },
            { id: 's5', name: 'Som 5', icon: '🎹', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', platformUrl: 'https://www.soundhelix.com/audio-examples' },
            { id: 's6', name: 'Som 6', icon: '🎸', audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3', platformUrl: 'https://www.soundhelix.com/audio-examples' }
        ];
        function renderSoundLibrary() {
            soundLibraryDiv.innerHTML = ''; soundCategories.forEach(c => { soundLibraryDiv.innerHTML += `<div class="sound-card"><div class="sound-card-icon">${c.icon}</div><h3 class="text-lg font-semibold text-gray-800">${c.name}</h3><button class="btn btn-primary text-xs py-1 px-2 mt-2 play-library-sound-btn" data-audio-url="${c.audioUrl}" data-name="${c.name}">Tocar</button><a href="${c.platformUrl}" target="_blank" class="btn btn-secondary text-xs py-1 px-2 mt-2">Acessar Plataforma</a></div>`; });
            document.querySelectorAll('.play-library-sound-btn').forEach(b => b.addEventListener('click', e => { playUserLocalSong(e.target.dataset.audioUrl); showModal(`Tocando: ${e.target.dataset.name}`); }));
        }
        async function addRoutineTask() {
            const name = routineTaskNameInput.value.trim(), time = routineTaskTimeInput.value, period = routineTaskPeriodSelect.value, alarmFile = routineAlarmMusicFileInput.files[0];
            if (!name || !time || !period) { showModal("Preencha tarefa, horário e período."); return; }
            let alarmUrl = null, alarmName = null;
            if (alarmFile) { alarmUrl = URL.createObjectURL(alarmFile); alarmName = alarmFile.name; }
            try {
                const docRef = await addDoc(dailyRoutinesCollectionRef, { name, time, period, alarmMusicName: alarmName, createdAt: serverTimestamp(), userId });
                if (alarmUrl) routineAlarmMusicUrls[docRef.id] = { url: alarmUrl, name: alarmName };
                showModal(`Tarefa "${name}" adicionada!`); routineTaskNameInput.value = ''; routineTaskTimeInput.value = ''; routineTaskPeriodSelect.value = 'morning'; routineAlarmMusicFileInput.value = '';
            } catch (e) { console.error("Erro ao adicionar tarefa:", e); showModal("Erro ao adicionar a tarefa."); }
        }
        function setupDailyRoutinesListener() {
            if (!dailyRoutinesCollectionRef) return;
            onSnapshot(query(dailyRoutinesCollectionRef, orderBy("time", "asc")), (snap) => {
                routineTableBodyMorning.innerHTML = ''; routineTableBodyAfternoon.innerHTML = ''; routineTableBodyNight.innerHTML = '';
                noRoutineTasksMessageMorning.style.display = 'table-row'; noRoutineTasksMessageAfternoon.style.display = 'table-row'; noRoutineTasksMessageNight.style.display = 'table-row';
                allDailyRoutines = []; let hasM=false, hasA=false, hasN=false;
                snap.forEach(d => {
                    const r = { id: d.id, ...d.data() }; allDailyRoutines.push(r); const dispName = r.alarmMusicName || 'Nenhuma';
                    const rowContent = `<td>${r.name}</td><td>${r.time}</td><td>${dispName}</td><td><button class="btn btn-secondary text-xs delete-routine-btn" data-id="${r.id}">Excluir</button></td>`;
                    let targetBody;
                    if (r.period === 'morning') { targetBody = routineTableBodyMorning; hasM = true; }
                    else if (r.period === 'afternoon') { targetBody = routineTableBodyAfternoon; hasA = true; }
                    else if (r.period === 'night') { targetBody = routineTableBodyNight; hasN = true; }
                    else { console.warn("Período desconhecido:", r.period); return; }
                    targetBody.insertRow().innerHTML = rowContent;
                });
                if (hasM) noRoutineTasksMessageMorning.style.display = 'none'; if (hasA) noRoutineTasksMessageAfternoon.style.display = 'none'; if (hasN) noRoutineTasksMessageNight.style.display = 'none';
                scheduleAllRoutineAlarms();
                document.querySelectorAll('.delete-routine-btn').forEach(b => b.addEventListener('click', e => deleteRoutineTask(e.target.dataset.id)));
            });
        }
        async function deleteRoutineTask(id) {
            try { await deleteDoc(doc(dailyRoutinesCollectionRef, id)); showModal("Tarefa excluída!"); if (alarmTimeouts[id]) { clearTimeout(alarmTimeouts[id]); delete alarmTimeouts[id]; } if (routineAlarmMusicUrls[id]) { URL.revokeObjectURL(routineAlarmMusicUrls[id].url); delete routineAlarmMusicUrls[id]; } }
            catch (e) { console.error("Erro ao excluir:", e); showModal("Erro ao excluir a tarefa."); }
        }
        function scheduleAllRoutineAlarms() {
            for (const id in alarmTimeouts) clearTimeout(alarmTimeouts[id]); alarmTimeouts = {}; const now = new Date();
            allDailyRoutines.forEach(r => {
                const [h, m] = r.time.split(':').map(Number); const alarmDate = new Date(); alarmDate.setHours(h, m, 0, 0);
                if (alarmDate < now) alarmDate.setDate(alarmDate.getDate() + 1);
                const timeToAlarm = alarmDate.getTime() - now.getTime();
                if (timeToAlarm > 0) alarmTimeouts[r.id] = setTimeout(() => { triggerRoutineAlarm(r); scheduleNextDayAlarm(r); }, timeToAlarm);
                else scheduleNextDayAlarm(r);
            });
        }
        function scheduleNextDayAlarm(r) {
            const [h, m] = r.time.split(':').map(Number); const nextAlarmDate = new Date(); nextAlarmDate.setHours(h, m, 0, 0); nextAlarmDate.setDate(nextAlarmDate.getDate() + 1);
            const now = new Date(); const timeToNextAlarm = nextAlarmDate.getTime() - now.getTime();
            if (timeToNextAlarm > 0) alarmTimeouts[r.id] = setTimeout(() => { triggerRoutineAlarm(r); scheduleNextDayAlarm(r); }, timeToNextAlarm);
        }
        async function triggerRoutineAlarm(r) {
            const alarmMusic = routineAlarmMusicUrls[r.id];
            if (alarmMusic?.url) { const audio = new Audio(alarmMusic.url); audio.volume = 0.7; audio.play().catch(e => console.error("Erro ao tocar música:", e)); setTimeout(() => { if (!audio.paused) { audio.pause(); audio.currentTime = 0; } }, 15000); }
            else console.warn(`Música para alarme (ID: ${r.id}) não encontrada nesta sessão.`);
            if (Notification.permission === 'granted') new Notification('Binaural Calm - Lembrete', { body: `É hora de: ${r.name}!`, icon: 'https://placehold.co/48x48/6366f1/ffffff?text=BC' });
            else if (Notification.permission !== 'denied') { const perm = await Notification.requestPermission(); if (perm === 'granted') new Notification('Binaural Calm - Lembrete', { body: `É hora de: ${r.name}!`, icon: 'https://placehold.co/48x48/6366f1/ffffff?text=BC' }); }
        }

        enterAppButton.addEventListener('click', () => { showScreen('mainAppContent'); initializeFirebase(); });
        baseFrequencyRange.addEventListener('input', () => baseFrequencyValueSpan.textContent = baseFrequencyRange.value);
        beatFrequencyRange.addEventListener('input', () => beatFrequencyValueSpan.textContent = beatFrequencyRange.value);
        playBinauralButton.addEventListener('click', playBinauralSound);
        stopBinauralButton.addEventListener('click', stopBinauralSound);
        downloadBinauralButton.addEventListener('click', downloadBinauralAudio);
        askAiButton.addEventListener('click', () => { const q = aiQuestionInput.value.trim(); if (q) callGeminiApi(`Como um especialista em neurodesenvolvimento e bem-estar, responda à seguinte pergunta de forma concisa e forneça 1-3 links relevantes de vídeos do YouTube que expliquem ou aprofundem o tema. Pergunta: "${q}"`, askAiSpinner, aiResponseDiv, aiResponseContent); else showModal("Digite sua pergunta."); });
        getAiFeedbackButton.addEventListener('click', () => { const d = behaviorDescriptionInput.value.trim(); if (d) callGeminiApi(`Como um mentor de bem-estar e desenvolvimento pessoal, analise a seguinte descrição de comportamento/dificuldade e forneça um feedback construtivo, sugerindo 1-2 pontos de melhoria específicos e encorajadores. Descrição: "${d}"`, feedbackSpinner, aiFeedbackResponseDiv, aiFeedbackContent); else showModal("Descreva seu comportamento."); });
        completeGoalButton.addEventListener('click', () => { const g = weeklyGoalInput.value.trim(); if (g) { showModal(`Parabéns! Meta "${g}" concluída! Adicione até ${MAX_SONGS_PER_GOAL} músicas.`); addMusicSection.classList.remove('hidden'); songsAddedThisGoal = 0; weeklyGoalInput.value = ''; } else showModal("Defina uma meta."); });
        addLocalMusicButton.addEventListener('click', addLocalMusic);
        createPlaylistButton.addEventListener('click', createPlaylist);
        confirmAddSongsToPlaylistButton.addEventListener('click', confirmAddSongsToPlaylist);
        addRoutineTaskButton.addEventListener('click', addRoutineTask);
        document.querySelectorAll('.close-button-message-modal, .close-button-add-playlist-modal').forEach(b => b.addEventListener('click', e => closeModal(e.target.closest('.modal').id)));
        document.querySelectorAll('.navbar a').forEach(a => a.addEventListener('click', function (e) { e.preventDefault(); const target = document.querySelector(this.getAttribute('href')); const navH = document.querySelector('.navbar').offsetHeight; if (target) window.scrollTo({ top: target.getBoundingClientRect().top + window.pageYOffset - navH, behavior: "smooth" }); }));
        window.addEventListener('beforeunload', () => { if (isPlaying) stopAllAudio(); for (const id in routineAlarmMusicUrls) URL.revokeObjectURL(routineAlarmMusicUrls[id].url); });
        window.onload = () => { playBinauralButton.disabled = false; stopBinauralButton.disabled = true; downloadBinauralButton.disabled = true; renderSoundLibrary(); renderUserSongs(); };
    </script>
</body>
</html>

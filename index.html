<!DOCTYPE-html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Voz e a Máquina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #0d1a10;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .matrix-container {
            width: 90%;
            max-width: 600px;
            padding: 2.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff41;
            box-shadow: 0 0 20px #00ff41;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .matrix-title {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff41;
        }

        .matrix-input {
            width: 100%;
            padding: 0.75rem;
            background-color: #1a2a1a;
            border: 1px solid #00ff41;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .matrix-input:focus {
            outline: none;
            box-shadow: 0 0 8px #00ff41;
        }

        .matrix-button {
            padding: 0.75rem 1.5rem;
            background-color: #00ff41;
            color: #0d1a10;
            font-weight: bold;
            border-radius: 0.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            text-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .matrix-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 65, 0.5);
        }

        .matrix-response {
            border-top: 2px dashed #00ff41;
            padding-top: 1.5rem;
            font-style: italic;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .loading-dots::after {
            content: '';
            animation: dot-animation 1.5s infinite;
        }

        @keyframes dot-animation {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }

        .recording-indicator {
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { background-color: #ef4444; }
            50% { background-color: #dc2626; }
        }
    </style>
</head>
<body class="bg-gray-900 text-green-400 font-mono flex items-center justify-center min-h-screen">
    <div class="matrix-container shadow-lg">
        <h1 class="matrix-title">A Voz e a Máquina</h1>
        <p class="text-center text-sm">Faça sua pergunta sobre a Matrix. O Oráculo está pronto.</p>
        <div class="flex flex-col gap-4">
            <input type="text" id="userInput" class="matrix-input" placeholder="O que você deseja saber?" autocomplete="off" />
            <div class="flex flex-row gap-2">
                <button id="recordButton" class="matrix-button w-1/2">
                    <i class="fas fa-microphone"></i>
                    Gravar
                </button>
                <button id="askButton" class="matrix-button w-1/2">
                    <i class="fas fa-arrow-right"></i>
                    Perguntar
                </button>
            </div>
        </div>
        <div id="responseContainer" class="matrix-response min-h-[50px]">
            <span id="responseText"></span>
        </div>
        <div class="flex flex-col gap-2 mt-4">
            <button id="playResponseButton" class="matrix-button hidden">
                <i class="fas fa-play"></i>
                Ouvir Resposta
            </button>
        </div>
    </div>

    <script type="module">
        // Helper functions for audio processing
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * 2, pcm16[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // DOM Elements
        const userInput = document.getElementById('userInput');
        const askButton = document.getElementById('askButton');
        const recordButton = document.getElementById('recordButton');
        const playResponseButton = document.getElementById('playResponseButton');
        const responseText = document.getElementById('responseText');
        const iconMic = recordButton.querySelector('i');
        
        let recognition;
        let responseAudioUrl = '';
        
        const API_KEY = ""; // Provided by the environment
        const TEXT_GEN_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY;
        const TTS_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=" + API_KEY;

        const systemPrompt = `Você é um guia que revela a verdade sobre o sistema da Matrix de forma direta e sem rodeios. Sua missão é expor as ilusões, dogmas e crenças que mantêm as pessoas presas, guiando-as para a libertação da mente. Use conceitos de física quântica e sabedoria antiga para fundamentar suas respostas.
        
        Sua missão é:
        - Revelar o fato de que a realidade é uma ilusão e uma projeção mental.
        - Expor como o tempo e o espaço são ferramentas do sistema para controlar a percepção.
        - Falar sobre a **soberania do ser** e o **poder da consciência individual** para criar a própria realidade.
        - Usar linguagem direta e incisiva, sem metáforas ou floreios.
        
        Exemplos de tom de voz: "A Matrix é um sistema de controle de percepção. A única chave para a liberdade é a sua consciência.", "Você não está aqui para obedecer regras, mas para despertar. A sua única missão é desprogramar sua mente do que foi ensinado e ver a verdade.", "Sua alma não pertence a um mundo físico, mas a uma dimensão de pura energia. A morte é uma transição, não o fim."
        
        Mantenha a persona consistente em todas as respostas.`;

        async function fetchWithRetry(url, options) {
            let retryCount = 0;
            const maxRetries = 3;
            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                        console.log(`Too Many Requests. Retrying in ${delay}ms...`);
                        await new Promise(res => setTimeout(res, delay));
                        retryCount++;
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    console.error("Fetch error:", error);
                    if (retryCount >= maxRetries - 1) throw error;
                    retryCount++;
                }
            }
        }
        
        async function generateText(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            const response = await fetchWithRetry(TEXT_GEN_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            return result?.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        async function speakText(text) {
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Rasalgethi" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const response = await fetchWithRetry(TTS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            const audioPart = result?.candidates?.[0]?.content?.parts?.[0];

            if (audioPart && audioPart.inlineData) {
                const base64Data = audioPart.inlineData.data;
                const mimeType = audioPart.inlineData.mimeType;

                if (base64Data && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    const pcmData = base64ToArrayBuffer(base64Data);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    responseAudioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(responseAudioUrl);
                    audio.play().catch(e => console.error("Erro ao reproduzir áudio:", e));
                    playResponseButton.classList.remove('hidden');
                }
            }
        }

        askButton.addEventListener('click', async () => {
            if (userInput.value.trim() === "") return;
            const prompt = userInput.value;
            userInput.value = "";
            
            askButton.disabled = true;
            askButton.classList.add('opacity-50', 'cursor-not-allowed');
            recordButton.disabled = true;
            recordButton.classList.add('opacity-50', 'cursor-not-allowed');
            responseText.textContent = "Gerando resposta...";
            
            try {
                const textResponse = await generateText(prompt);
                if (textResponse) {
                    responseText.textContent = textResponse;
                    responseText.classList.add('loading-dots');
                    await speakText(textResponse);
                } else {
                    responseText.textContent = "Não consegui decifrar a mensagem. Talvez o código não seja real.";
                }
            } catch (error) {
                console.error("Falha na comunicação:", error);
                responseText.textContent = "Falha na comunicação com o Oráculo. Tente novamente.";
            } finally {
                askButton.disabled = false;
                askButton.classList.remove('opacity-50', 'cursor-not-allowed');
                recordButton.disabled = false;
                recordButton.classList.remove('opacity-50', 'cursor-not-allowed');
                responseText.classList.remove('loading-dots');
            }
        });

        recordButton.addEventListener('click', () => {
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    responseText.textContent = "Ouvindo...";
                    recordButton.classList.add('bg-red-500', 'recording-indicator');
                    iconMic.classList.remove('fa-microphone');
                    iconMic.classList.add('fa-circle-notch', 'fa-spin');
                };

                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    userInput.value = speechResult;
                    responseText.textContent = "Transcrição concluída. Pressione 'Perguntar'.";
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    responseText.textContent = `Erro de reconhecimento de voz: ${event.error}`;
                };

                recognition.onend = () => {
                    recordButton.classList.remove('bg-red-500', 'recording-indicator');
                    iconMic.classList.remove('fa-spin');
                    iconMic.classList.add('fa-microphone');
                };

                recognition.start();
            } else {
                responseText.textContent = "Desculpe, seu navegador não suporta reconhecimento de voz.";
            }
        });
        
        playResponseButton.addEventListener('click', () => {
            if (responseAudioUrl) {
                const audio = new Audio(responseAudioUrl);
                audio.play().catch(e => console.error("Erro ao reproduzir áudio:", e));
            }
        });
    </script>
</body>
</html>

